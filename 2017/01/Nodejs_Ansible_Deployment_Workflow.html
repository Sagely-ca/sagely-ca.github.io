<!DOCTYPE html>
<html class="no-js">

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Sagely Go... | Node.js Ansible Deployment Workflow</title>
    <meta name="description" content="An overview of the deployment workflow for Pwn9's node.js based website.  From development to Production">

    <link rel="stylesheet" href="/css/main.css">
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="canonical" href="http://sagely.ca/2017/01/Nodejs_Ansible_Deployment_Workflow">
    <link rel="alternate" type="application/rss+xml" title="Sagely Go..." href="http://sagely.ca/feed.xml" />

    <!--[if lt IE 9]>
        <script src="/js/vendor/html5shiv.min.js"></script>
    <![endif]-->
</head>


  <body class="">
    <!-- if the user has javascript disabled they can still use the menu -->
<noscript>
    <div class="no-js-menu clearfix">
        <ul>
            
                <li><i class="fa fa-home"></i><a href="/">Home</a></li>
            
                <li><i class="fa fa-anchor"></i><a href="/about">About</a></li>
            
                <li><i class="fa fa-user"></i><a href="/author/sage905">Author</a></li>
            
        </ul>
    </div>
</noscript>
<!-- end no script -->

    <header class="hero-image" style="background-image: url('/img/feature-puzzle.jpg');">
    <span class="menu-trigger animated fadeInDown">
        <span class="bar"></span>
        <span class="bar"></span>
        <span class="bar"></span>
    </span>

    <div id="menu-target">
    <ul>
        
            <li><i class="fa fa-home"></i><a href="/">Home</a></li>
        
            <li><i class="fa fa-anchor"></i><a href="/about">About</a></li>
        
            <li><i class="fa fa-user"></i><a href="/author/sage905">Author</a></li>
        
    </ul>
</div>

</header>

<main class="container">
    <div class="row">
        <div class="col-xs-12 single-content">
            <p class="meta">
                <a href="/author/sage905">Sage905</a> in <a href='/category/coding'>Coding</a> <i class="link-spacer"></i>
            </p>
            
            <p class="meta">
                <i class="fa fa-tags" ></i> nodejs ansible deployment pm2 pwn9 git githooks nginx
            </p>
            

            <h1>Node.js Ansible Deployment Workflow</h1>

            <div class="sect1">
<h2 id="background">Background</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Pwn9.com&#8217;s website ran on Drupal for years.  Recently, the backend just stopped responding to requests, and after spending about 30 minutes trying to figure out what was hosed, I gave up.  We had long been intending to replace the Drupal site with something else, and this seemed like a good enough motivation to do it.</p>
</div>
<div class="paragraph">
<p>Both Tremor and I have become interested in node.js, and we wanted to incorporate some webhooks, RESTful interfaces, etc.  You know&#8230;&#8203; The stuff all the k00lk1ds are using these days.</p>
</div>
<div class="paragraph">
<p>What follows is a description of the development &#8594; production workflow that I&#8217;ve set up.  There may very well be better ways of doing this, but this was the one I ended up with, because it appeals to my sensibilities.  (Tremor probably disagrees) :)  Well, tough bananas.  I&#8217;m the one actually putting the time into it. :)</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="overview">Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The workflow relies on the following components:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Development Server from CloudAtCost</p>
</li>
<li>
<p>Production Server on Linode</p>
</li>
<li>
<p>Ansible for automation</p>
</li>
<li>
<p>Node.js &amp; NPM for application</p>
</li>
<li>
<p>PM2 to manage the Node.js App</p>
</li>
<li>
<p>Nginx for reverse-proxy to the nodejs app</p>
</li>
<li>
<p>Git &amp; Gitolite for version control / repo</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>At a high level, the workflow will look like this:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Clone or pull from the private gitolite-based repository</p>
</li>
<li>
<p>Checkout dev branch.</p>
</li>
<li>
<p>Hack on the code.  Test.  Repeat until it&#8217;s shippable.</p>
</li>
<li>
<p>Commit changes and push dev branch back to gitolite repo.</p>
</li>
<li>
<p>A githook will fire, notifying the CI machine to build/test the code.</p>
</li>
<li>
<p>If the tests pass, the code will automatically be promoted to the staging server at pwn9.sagely.ca by executing an ansible playbook against the development environment.</p>
</li>
<li>
<p>In theory, additional production-readiness testing can be done against the staging server.</p>
</li>
<li>
<p>Once the dev is confident that the changes are ready for production, the dev requests that a Manager promotes it to production (at the moment, that is just me.  Maybe tremor)</p>
</li>
<li>
<p>Promotion to production involves running an ansible playbook against the production environment.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>We are going to use a similar Git model to this one: <a href="http://nvie.com/posts/a-successful-git-branching-model/" class="bare">http://nvie.com/posts/a-successful-git-branching-model/</a></p>
</div>
<div class="paragraph">
<p>To simplify the automated build system, we are going to use the following nomenclature:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">master</dt>
<dd>
<p>Release only branch.  ALL changes that go in here will be releases and automatically pushed to production. (eek!)  Nothing gets into here before rigorous testing.</p>
</dd>
<dt class="hdlist1">fix/&lt;bugid&gt;</dt>
<dd>
<p>For fixes to specific bugs.  Where should we track the issues?  Trello?  These branches will be based off the <code>master</code> branch and will be committed to <code>master</code> as well as <code>develop</code></p>
</dd>
<dt class="hdlist1">develop</dt>
<dd>
<p>This branch is where all new features and updates will be merged into.  All changes pushed to the repo in one of the branches below will automatically be built and tested by Jenkins, and if the build passes will be auto-merged into this branch.</p>
</dd>
<dt class="hdlist1">feature/&lt;featurename&gt;</dt>
<dd>
<p>For big features, eg: new authentication, new game API, etc.  These branches will be made off the <code>develop</code> branch, and will be automatically be integrated when builds are pushed and passed.</p>
</dd>
<dt class="hdlist1">update/&lt;name&gt;</dt>
<dd>
<p>For smaller updates, eg: to page styling, layout, etc.  These branches will be made off the <code>develop</code> branch, and will be automatically be integrated when builds are pushed and passed.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>So, if, for example, you wish to add a new feature, you would:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">$ git checkout -b feature/awesome-new-feature develop
# This creates a new branch 'feature/awesome-new-feature' based on the 'develop' branch</code></pre>
</div>
</div>
</div>
</div>


            
            <div id="disqus_thread"></div>
            <script>

                /**
                 *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
                 *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
                var disqus_config = function () {
                    this.page.url = "http://sagely.ca/2017/01/Nodejs_Ansible_Deployment_Workflow";  // Replace PAGE_URL with your page's canonical URL variable
                    this.page.identifier = "/2017/01/Nodejs_Ansible_Deployment_Workflow"; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
                };

                (function() { // DON'T EDIT BELOW THIS LINE
                    var d = document, s = d.createElement('script');
                    s.src = '//sagely.disqus.com/embed.js';
                    s.setAttribute('data-timestamp', +new Date());
                    (d.head || d.body).appendChild(s);
                })();
            </script>
            <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

            

        </div><!-- main-content/col -->
    </div> <!--/row -->

</main> <!-- /container -->


<footer class="single">
    <div class="container">
    <div class="row">
        <div class="col-xs-12 col-sm-2">
            <img src="/img/sage.jpg" class="user-icon " alt="user-image">
        </div>
        <div class="col-xs-12 col-sm-6">
            <div class="category-list">
                <p>Published <span>Jan 22, 2017</span></p>
                <p><a href="/author/sage905">Sage905</a> in <a href='/category/coding'>Coding</a></p>

                <div class="other-catergories">
                    <h3>Also found in</h3>

                    <ul>
                        
                        <li>
                            <a href='/category/coding'>Coding</a>
                            
                        </li>
                        
                    </ul>
                </div>
            </div>
        </div><!-- end col -->
        <div class="col-xs-12 col-sm-4">
            <div class="social">
                <p>Share this article</p>
                <div class="social-links">
                    <a class="social-icon" href="#" data-platform="twitter" data-message="" data-url="http://sagely.ca/2017/01/Nodejs_Ansible_Deployment_Workflow"><i class="fa fa-twitter"></i></a>

                    <a class="social-icon" href="#" data-platform="facebook" data-message="" data-url="http://sagely.ca/2017/01/Nodejs_Ansible_Deployment_Workflow"><i class="fa fa-facebook-official"></i></a>
                    <a class="social-icon" data-platform="mail"  href="mailto:?body=http://sagely.ca/2017/01/Nodejs_Ansible_Deployment_Workflow"><i class="fa fa-envelope"></i></a>
                </div>
            </div>
        </div>
    </div><!-- end row -->
</div>


    
        <div class="row read-another-section">
    
        
        <a href="/2017/01/pwn9site-tutorial"><div class="col-sm-6 col-md-2 no-gutter read-another-container">
            <div class="overlay"></div>
            <img src='/img/recommend-laptop.jpg'>
            <h3 class="read-another">Tutorial for working with the Pwn9 Site Repo</h3>
        </div></a>
        
    
        
        <a href="/2017/01/Social_Notworking"><div class="col-sm-6 col-md-2 no-gutter read-another-container">
            <div class="overlay"></div>
            <img src='/img/recommend-wolf.jpg'>
            <h3 class="read-another">Social Notworking</h3>
        </div></a>
        
    
        
        <a href="/2017/01/Ansible_to_Manage_Personal_Servers"><div class="col-sm-6 col-md-2 no-gutter read-another-container">
            <div class="overlay"></div>
            <img src='/img/recommend-laptop.jpg'>
            <h3 class="read-another">Ansible to Manage Personal Servers</h3>
        </div></a>
        
    
        
        <a href="/2016/12/Jekyll-and-AsciiDoc"><div class="col-sm-6 col-md-2 no-gutter read-another-container">
            <div class="overlay"></div>
            <img src='/img/recommend-laptop.jpg'>
            <h3 class="read-another">Jekyll and Asciidoc</h3>
        </div></a>
        
    
        
        <a href="/2016/03/AWS_Certifications"><div class="col-sm-6 col-md-2 no-gutter read-another-container">
            <div class="overlay"></div>
            <img src='/img/recommend-laptop.jpg'>
            <h3 class="read-another">Amazon Web Services Certifications</h3>
        </div></a>
        
    
        
        <a href="/2017/01/Politics"><div class="col-sm-6 col-md-2 no-gutter read-another-container">
            <div class="overlay"></div>
            <img src='/img/recommend-fire.jpg'>
            <h3 class="read-another">My Politics</h3>
        </div></a>
        
    
        
    
</div>
    
</footer>


    <script src='/js/vendor/modernizr.custom.32229-2.8-respondjs-1-4-2.js'></script>
    <script src="/js/vendor/jquery-1.11.2.min.js"></script>
    <script src='/js/vendor/jquery.jpanelmenu.min.js'></script>
    <script type='application/javascript' src='/js/vendor/fastclick.min.js'></script>
    
    <script src=' /js/main.js'></script>
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-89685712-1', 'auto');
        ga('send', 'pageview');

    </script>
  </body>

</html>
