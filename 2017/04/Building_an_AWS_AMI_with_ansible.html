<!DOCTYPE html>
<html class="no-js">

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Sagely Go... | Building an AWS AMI with Ansible</title>
    <meta name="description" content="Using Ansible to automate the base config for a custom AMI">

    <link rel="stylesheet" href="/css/main.css">
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="canonical" href="http://sagely.ca/2017/04/Building_an_AWS_AMI_with_ansible">
    <link rel="alternate" type="application/rss+xml" title="Sagely Go..." href="http://sagely.ca/feed.xml" />

    <!--[if lt IE 9]>
        <script src="/js/vendor/html5shiv.min.js"></script>
    <![endif]-->
</head>


  <body class="">
    <!-- if the user has javascript disabled they can still use the menu -->
<noscript>
    <div class="no-js-menu clearfix">
        <ul>
            
                <li><i class="fa fa-home"></i><a href="/">Home</a></li>
            
                <li><i class="fa fa-anchor"></i><a href="/about">About</a></li>
            
                <li><i class="fa fa-user"></i><a href="/author/sage905">Author</a></li>
            
        </ul>
    </div>
</noscript>
<!-- end no script -->

    <header class="hero-image" style="background-image: url('/img/feature-puzzle.jpg');">
    <span class="menu-trigger animated fadeInDown">
        <span class="bar"></span>
        <span class="bar"></span>
        <span class="bar"></span>
    </span>

    <div id="menu-target">
    <ul>
        
            <li><i class="fa fa-home"></i><a href="/">Home</a></li>
        
            <li><i class="fa fa-anchor"></i><a href="/about">About</a></li>
        
            <li><i class="fa fa-user"></i><a href="/author/sage905">Author</a></li>
        
    </ul>
</div>

</header>

<main class="container">
    <div class="row">
        <div class="col-xs-12 single-content">
            <p class="meta">
                <a href="/author/sage905">Sage905</a> in <a href='/category/aws'>Aws</a> <i class="link-spacer"></i>
            </p>
            
            <p class="meta">
                <i class="fa fa-tags" ></i> aws cloud ansible automation minecraft
            </p>
            

            <h1>Building an AWS AMI with Ansible</h1>

            <div class="sect1">
<h2 id="introduction">Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>I have spent the past couple of weeks drinking from the firehose on AWS and it&#8217;s various service offerings.  I&#8217;m at the point where I need to take some of this theoretical knowledge and lab experience to build something that will actually run in production.  What better way to experiment than on pwn9.com. :)</p>
</div>
<div class="paragraph">
<p>The first thing I want to do is to turn the Pwn9.com Minecraft server into an on-demand instance that is spun up and torn down based on whether or not any players are online.  The steps I need to take to do this are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Create an EC2 instance to be the base for the MC Server AMI</p>
</li>
<li>
<p>Use Ansible to provision the EC2 instance with the required config</p>
</li>
<li>
<p>Create an EBS volume to store the MC data / config</p>
</li>
<li>
<p>Place the Pwn9 server data on the Data volume</p>
</li>
<li>
<p>Run tests on the instance to ensure it works correctly</p>
</li>
<li>
<p>Detach the Data volume and Create the AMI</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="battle_plan">Battle Plan</h2>
<div class="sectionbody">
<div class="paragraph">
<p>I am going to start by building an Amazon AMI that I can use to create the Minecraft server instance.</p>
</div>
<div class="paragraph">
<p>GOOD NEWS: I already have Ansible configurations that provide me with the base configuration that I&#8217;m already using on our live site.</p>
</div>
<div class="paragraph">
<p>BAD NEWS: Amazon Linux != CentOS.  Some tweaks were necessary.  Fortunately, it only took me half an hour or so to adapt.</p>
</div>
<div class="paragraph">
<p>Building the AMI consisted of running my ansible playbook against a brand new EC2 instance.  I created an instance with 2 EBS Volumes, one for the OS, and one for the game data.  The root EBS volume will be auto-destroyed when the instance is terminated, but the game data will persist.</p>
</div>
<div class="paragraph">
<p>The EBS Game Data Volume led to a bit of a challenge.  There&#8217;s no way in the spot request to specify an existing EBS volume to be attached to the instance.  The only option is to attach a snapshot.  So that leaves me with a couple of options:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>When terminating each instance, create a snapshot of the extra volume, to persist the data.  Use the new snapshot on each server startup.  This doesn&#8217;t feel right, because I could get out of sync if the workflow broke down.</p>
</li>
<li>
<p>Write a script in user-data so that the instance will auto-attach the Game Data EBS Volume.  Then, the volume can be mounted.  This will all happen before the mineos process starts.  This has the advantage of having a single EBS volume that is the source of truth for the Game Data.  The drawback is that this limits which Availability Zone the instance can be spawned in.  This shouldn&#8217;t be too big an issue, though it may drive up the spot price a bit if there&#8217;s higher demand in that AZ.  The quick-and-dirty script I used is below.  Long-term, I will need to refactor this into something with some error handling. :)</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>#!/bin/bash
aws ec2 attach-volume --volume-id vol-0e9dba8af2b10f02e --instance-id `curl -s -o - http://169.254.169.254/latest/meta-data/instance-id/` --device xvdc --region us-east-1
while [ ! -e /dev/xvdc ]; do sleep 1; done
mount -a
restart mineos</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="instance_launch_termination">Instance Launch / Termination</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The automated server workflow will be:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Wait for a player to connect to mc.pwn9.com, which is a t2.micro instance running bungeecord and a tiny lobby server.</p>
</li>
<li>
<p>Player requests to connect to main minecraft server by executing a /server &lt;eg: anarchy&gt; command.</p>
</li>
<li>
<p>Bungeecord plugin (custom?) checks to see if the server is up.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>If exists, connect player.</p>
</li>
<li>
<p>If not exists, send player a message: "Hang on, we&#8217;re setting it up for you!", and fire AWS API call to initate server creation.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Once server is ready, bungeecord informs player, and allows them to re-execute the /server &lt;servername&gt; command to join the newly spun up server</p>
</li>
<li>
<p>Use Cloudwatch to monitor the player count.  When it reaches 0 for more than 15 minutes, terminate the Spot request.</p>
</li>
<li>
<p>Goto #1. :)</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="todos">TODOs</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Enable auto-DNS registration</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="caveats">Caveats</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A few of the things I discovered along the way:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Cost Gotchas</dt>
<dd>
<p>AWS charges $0.09 per GB of data transfer out.  If we assume that the average player uses 50kb/s of throughput while connected, it works out to about 1.62 cents per player hour. On a server with an average of 60 player months worth of connections, that works out to about $90 / mo in BW alone.  Something for larger servers to consider.</p>
</dd>
</dl>
</div>
</div>
</div>


            
            <div id="disqus_thread"></div>
            <script>

                /**
                 *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
                 *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
                var disqus_config = function () {
                    this.page.url = "http://sagely.ca/2017/04/Building_an_AWS_AMI_with_ansible";  // Replace PAGE_URL with your page's canonical URL variable
                    this.page.identifier = "/2017/04/Building_an_AWS_AMI_with_ansible"; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
                };

                (function() { // DON'T EDIT BELOW THIS LINE
                    var d = document, s = d.createElement('script');
                    s.src = '//sagely.disqus.com/embed.js';
                    s.setAttribute('data-timestamp', +new Date());
                    (d.head || d.body).appendChild(s);
                })();
            </script>
            <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

            

        </div><!-- main-content/col -->
    </div> <!--/row -->

</main> <!-- /container -->


<footer class="single">
    <div class="container">
    <div class="row">
        <div class="col-xs-12 col-sm-2">
            <img src="/img/sage.jpg" class="user-icon " alt="user-image">
        </div>
        <div class="col-xs-12 col-sm-6">
            <div class="category-list">
                <p>Published <span>Apr 1, 2017</span></p>
                <p><a href="/author/sage905">Sage905</a> in <a href='/category/aws'>Aws</a></p>

                <div class="other-catergories">
                    <h3>Also found in</h3>

                    <ul>
                        
                        <li>
                            <a href='/category/aws'>Aws</a>
                            
                        </li>
                        
                    </ul>
                </div>
            </div>
        </div><!-- end col -->
        <div class="col-xs-12 col-sm-4">
            <div class="social">
                <p>Share this article</p>
                <div class="social-links">
                    <a class="social-icon" href="#" data-platform="twitter" data-message="" data-url="http://sagely.ca/2017/04/Building_an_AWS_AMI_with_ansible"><i class="fa fa-twitter"></i></a>

                    <a class="social-icon" href="#" data-platform="facebook" data-message="" data-url="http://sagely.ca/2017/04/Building_an_AWS_AMI_with_ansible"><i class="fa fa-facebook-official"></i></a>
                    <a class="social-icon" data-platform="mail"  href="mailto:?body=http://sagely.ca/2017/04/Building_an_AWS_AMI_with_ansible"><i class="fa fa-envelope"></i></a>
                </div>
            </div>
        </div>
    </div><!-- end row -->
</div>


    
        <div class="row read-another-section">
    
        
        <a href="/2017/01/Social_Notworking"><div class="col-sm-6 col-md-2 no-gutter read-another-container">
            <div class="overlay"></div>
            <img src='/img/recommend-wolf.jpg'>
            <h3 class="read-another">Social Notworking</h3>
        </div></a>
        
    
        
        <a href="/2017/01/pwn9site-tutorial"><div class="col-sm-6 col-md-2 no-gutter read-another-container">
            <div class="overlay"></div>
            <img src='/img/recommend-laptop.jpg'>
            <h3 class="read-another">Tutorial for working with the Pwn9 Site Repo</h3>
        </div></a>
        
    
        
        <a href="/2017/01/Ansible_to_Manage_Personal_Servers"><div class="col-sm-6 col-md-2 no-gutter read-another-container">
            <div class="overlay"></div>
            <img src='/img/recommend-laptop.jpg'>
            <h3 class="read-another">Ansible to Manage Personal Servers</h3>
        </div></a>
        
    
        
        <a href="/2017/01/Nodejs_Ansible_Deployment_Workflow"><div class="col-sm-6 col-md-2 no-gutter read-another-container">
            <div class="overlay"></div>
            <img src='/img/recommend-laptop.jpg'>
            <h3 class="read-another">Node.js Ansible Deployment Workflow</h3>
        </div></a>
        
    
        
        <a href="/2016/12/Jekyll-and-AsciiDoc"><div class="col-sm-6 col-md-2 no-gutter read-another-container">
            <div class="overlay"></div>
            <img src='/img/recommend-laptop.jpg'>
            <h3 class="read-another">Jekyll and Asciidoc</h3>
        </div></a>
        
    
        
        <a href="/2017/03/AWS_Certifications"><div class="col-sm-6 col-md-2 no-gutter read-another-container">
            <div class="overlay"></div>
            <img src='/img/recommend-laptop.jpg'>
            <h3 class="read-another">Amazon Web Services Certifications</h3>
        </div></a>
        
    
        
    
        
    
</div>
    
</footer>


    <script src='/js/vendor/modernizr.custom.32229-2.8-respondjs-1-4-2.js'></script>
    <script src="/js/vendor/jquery-1.11.2.min.js"></script>
    <script src='/js/vendor/jquery.jpanelmenu.min.js'></script>
    <script type='application/javascript' src='/js/vendor/fastclick.min.js'></script>
    
    <script src=' /js/main.js'></script>
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-89685712-1', 'auto');
        ga('send', 'pageview');

    </script>
  </body>

</html>
